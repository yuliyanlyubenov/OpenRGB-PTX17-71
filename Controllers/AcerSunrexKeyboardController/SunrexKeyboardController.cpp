/*---------------------------------------------------------*\
| SunrexKeyboardController.cpp                              |
|                                                           |
|   Driver for Acer Sunrex USB Keyboard                     |
|                                                           |
|   Yuliyan Lyubenov                            18 Mar 2025 |
|                                                           |
|   This file is part of the OpenRGB project                |
|   SPDX-License-Identifier: GPL-2.0-only                   |
\*---------------------------------------------------------*/

#include <cstring>
#include "StringUtils.h"
#include "SunrexKeyboardController.h"

using namespace std::chrono_literals;

//0xFFFFFFFF indicates an unused entry in matrix
#define NA  0xFFFFFFFF

/*-----------------------------------------*\
| Skip these indices in the color output    |
\*-----------------------------------------*/
static const unsigned int SKIP_INDICES[] = { 10, 29, 35, 47, 53,71, 75, 76, 77, 79,80,81,82,85,86,87,};

SunrexKeyboardController::SunrexKeyboardController(hid_device* dev_handle, const char* path)
{
    dev         = dev_handle;
    location    = path;

    effect_mode = SUNREX_KEYBOARD_MODE_STATIC;
}

SunrexKeyboardController::~SunrexKeyboardController()
{
    hid_close(dev);
}

std::string SunrexKeyboardController::GetDeviceLocation()
{
    return("HID " + location);
}

std::string SunrexKeyboardController::GetSerialString()
{
    wchar_t serial_string[128];
    int ret = hid_get_serial_number_string(dev, serial_string, 128);

    if(ret != 0)
    {
        return("");
    }

    return(StringUtils::wstring_to_string(serial_string));
}

void SunrexKeyboardController::PrepareHeader(unsigned char* packet, unsigned char brightness)
{
    PrepareHeader(packet, 0x1C, 0x02, brightness, 0xFF); // Custom 2, 2, -, separator
}

void SunrexKeyboardController::PrepareHeader(unsigned char* packet, unsigned char mode, unsigned char speed, unsigned char brightness, unsigned char color)
{
    /*-----------------------------------------------------*\
    | Prepare packet header                                 |
    \*-----------------------------------------------------*/
    packet[0x00]   = 0x04; // Report ID
    packet[0x01]   = 0xAE; // RGB Control Packet (KB = 0xA0)
    packet[0x02]   = 0x01; // unk
    packet[0x05]   = mode; // Mode
    packet[0x06]   = speed; // Speed, 0-4
    packet[0x07]   = brightness; // Brightness, 0-4
    packet[0x08]   = color; // Separator FF or Color, 0-7 (0-6 in static color mode) (Rainbow,) R, G, B, Y, M, C, W
}

void SunrexKeyboardController::SetLEDDirect(const std::vector<RGBColor>& colors, unsigned char brightness)
{
    /*-----------------------------------------------------*\
    | Default packets initialization                        |
    \*-----------------------------------------------------*/
    unsigned char start[9] = {0,0x12,0x00,0x00,0x08,0x00,0x00,0x00,0xe5};

    unsigned char data1[65] = {0,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0xc7,0x03,0x0f,0x00,0x03,0xc7,0x1d,0x00,0xc7,0x06,0x03,0x00,0x00,0x00,0x00,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0xc7,0x03,0x0f,0x00,0xc7,0x06,0x03,0x00,0xc7,0x06,0x03};
    unsigned char data2[65] = {0,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0xc7,0x03,0x0f,0x00,0x03,0xc7,0x1d,0x00,0xc7,0x06,0x03,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0xc7,0x03,0x0f,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x00,0x00,0x00,0x00,0x03,0xc7,0x1d,0x00,0xc7,0x03,0x0f};
    unsigned char data3[65] = {0,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x00,0x00,0x00,0x00,0x03,0xc7,0x1d,0x00,0xc7,0x03,0x0f,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0xc7,0x03,0x0f,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x00,0x00,0x00};
    unsigned char data4[65] = {0,0x00,0x03,0xc7,0x1d,0x00,0xc7,0x03,0x0f,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x00,0x00,0x00,0x00,0x03,0xc7,0x1d,0x00,0xc7,0x03,0x0f,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0xc7,0x03,0x0f,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d};
    unsigned char data5[65] = {0,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x00,0x00,0x00,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xc7,0x1d,0x00,0x00,0x00,0x00};
    unsigned char data6[65] = {0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xc7,0x1d,0x00,0xc7,0x03,0x06,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0xc7,0x03,0x06,0x00,0xc7,0x03,0x06};
    unsigned char data7[65] = {0,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0x03,0xc7,0x1d,0x00,0xc7,0x03,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
    unsigned char data8[65] = {0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
    
    unsigned char end[9] = {0,0x08,0x02,0x33,0x05,0x32,0x08,0x01,0x82};
    unsigned int buf_idx = 0;
    unsigned char *data_bufs[8] = {data1,data2,data3,data4,data5,data6,data7,data8};

    unsigned int skip_size = sizeof(SKIP_INDICES)  / sizeof(unsigned int);

    /*-----------------------------------------------------*\
    | Set concreate colors in buffers                       |
    \*-----------------------------------------------------*/
    buf_idx = 0;

    for (unsigned int color_idx = 0; color_idx < colors.size(); ++color_idx) {
      for (unsigned int skip_idx = 0; skip_idx < skip_size; ++skip_idx) {
        if (buf_idx == SKIP_INDICES[skip_idx]) {
          ++buf_idx;
        }
      }


      (data_bufs[buf_idx / 16])[((buf_idx % 16)*4) + 2] = RGBGetRValue(colors[color_idx]);
      (data_bufs[buf_idx / 16])[((buf_idx % 16)*4) + 3] = RGBGetGValue(colors[color_idx]);
      (data_bufs[buf_idx / 16])[((buf_idx % 16)*4) + 4] = RGBGetBValue(colors[color_idx]);

      ++buf_idx;

    }
    
    /*-----------------------------------------------------*\
    | Send buffers to the device                            |
    \*-----------------------------------------------------*/
    hid_send_feature_report(dev, start, sizeof(start));
    hid_write(dev, data1, sizeof(data1));
    hid_write(dev, data2, sizeof(data2));
    hid_write(dev, data3, sizeof(data3));
    hid_write(dev, data4, sizeof(data4));
    hid_write(dev, data5, sizeof(data5));
    hid_write(dev, data6, sizeof(data6));
    hid_write(dev, data7, sizeof(data7));
    hid_write(dev, data8, sizeof(data8));
    hid_send_feature_report(dev, end, sizeof(end));

    std::this_thread::sleep_for(SUNREX_KEYBOARD_DELAY);
}

unsigned char SunrexKeyboardController::RGBToPalette(unsigned char red,
                                                      unsigned char grn,
                                                      unsigned char blu
                                                     )
{
    /*------------------------*\
    | 0 0 1 (1) -> (1) Red     |
    | 0 1 0 (2) -> (2) Green   |
    | 0 1 1 (3) -> (4) Yellow  |
    | 1 0 0 (4) -> (3) Blue    |
    | 1 0 1 (5) -> (5) Magenta |
    | 1 1 0 (6) -> (6) Cyan    |
    | 1 1 1 (7) -> (7) White   |
    \*------------------------*/
    unsigned char color_mask = ((blu > 127) << 2 & 4) | ((grn > 127) << 1 & 2) | ((red > 127) & 1);

    switch(color_mask) // (Rainbow/Off,) R, G, B, Y, M, C, W
    {
        case 3:
            return 4;
        case 4:
            return 3;
        default:
            return color_mask;
    }
}

void SunrexKeyboardController::SetEffect(unsigned char mode,
                                     unsigned char speed,
                                     unsigned char brightness,
                                     bool          random,
                                     unsigned char red,
                                     unsigned char grn,
                                     unsigned char blu
                                    )
{
    unsigned char buf[9];

    /*-----------------------------------------------------*\
    | Zero out buffer and prepare packet header             |
    \*-----------------------------------------------------*/
    unsigned char one[9] = {0,0xb1,0x0,0x0,0x0,0x0,0x0,0x0,0x4e};
    unsigned char two[9] = {0,0x8,0x2,0x0,0x0,0x0,0x0,0x0,0xf5};
    unsigned char mstatic[9] = {0,0x08,0x02,0x01,0x0a,0x32,0x00,0x00,0xb8};
    unsigned char mwave[9] = {0,0x08,0x02,0x03,0x05,0x32,0x00,0x06,0xb5};
    unsigned char mripple[9] = {0,0x08,0x02,0x06,0x05,0x32,0x00,0x00,0xb8};
    unsigned char mraindrop[9] = {0,0x08,0x02,0x0a,0x05,0x32,0x00,0x00,0xb4};
    unsigned char mfireball[9] = {0,0x08,0x02,0x27,0x05,0x32,0x00,0x00,0x97};
    unsigned char mheartbeat[9] = {0,0x08,0x02,0x29,0x05,0x32,0x00,0x00,0x95};
    unsigned char mbreathing[9] = {0,0x08,0x02,0x02,0x05,0x32,0x00,0x00,0xbc};
    unsigned char msnake[9] = {0,0x08,0x02,0x05,0x05,0x32,0x00,0x00,0xb9};
    unsigned char mneon[9] = {0,0x08,0x02,0x08,0x05,0x32,0x00,0x00,0xb6};
    unsigned char mlighting[9] = {0,0x08,0x02,0x12,0x05,0x32,0x00,0x00,0xac};
    unsigned char msnow[9] = {0,0x08,0x02,0x28,0x05,0x32,0x00,0x00,0x96};
    unsigned char four[9] = {0,0x14,0x00,0x00,0x0,0x0,0x0,0x00,0xeb};

    int send_color = 1;

    memcpy(buf, one, sizeof(buf));
    hid_send_feature_report(dev, buf, sizeof(buf));

    memcpy(buf, two, sizeof(buf));
    hid_send_feature_report(dev, buf, sizeof(buf));

    memcpy(buf, mstatic, sizeof(buf));
    switch(mode)
    {
    case SUNREX_KEYBOARD_MODE_CUSTOM: // TODO Custom:
        memcpy(buf, mstatic, sizeof(buf));
        break;
    case SUNREX_KEYBOARD_MODE_STATIC: // Static:
        memcpy(buf, mstatic, sizeof(buf));
        break;
    case SUNREX_KEYBOARD_MODE_WAVES: // Waves:
        memcpy(buf, mwave, sizeof(buf));
        send_color = 0;
        break;
    case SUNREX_KEYBOARD_MODE_RIPPLE: // Ripple:
        memcpy(buf, mripple, sizeof(buf));
        break;
    case SUNREX_KEYBOARD_MODE_RAINDROP: // Rain drop:
        memcpy(buf, mraindrop, sizeof(buf));
        break;
    case SUNREX_KEYBOARD_MODE_FIREBALL: // Fireball:
        memcpy(buf, mfireball, sizeof(buf));
        break;
    case SUNREX_KEYBOARD_MODE_HEARTBEAT: // Heartbeat:
        memcpy(buf, mheartbeat, sizeof(buf));
        break;
    case SUNREX_KEYBOARD_MODE_BREATHING: // Breathing:
        memcpy(buf, mbreathing, sizeof(buf));
        break;
    case SUNREX_KEYBOARD_MODE_SNAKE: // Snake:
        memcpy(buf, msnake, sizeof(buf));
        break;
    case SUNREX_KEYBOARD_MODE_NEON: // Neon:
        memcpy(buf, mneon, sizeof(buf));
        send_color = 0;
        break;
    case SUNREX_KEYBOARD_MODE_LIGHTING: // Lighting:
        memcpy(buf, mlighting, sizeof(buf));
        break;
    case SUNREX_KEYBOARD_MODE_SNOW: // Snow:
        memcpy(buf, msnow, sizeof(buf));
        break;
    default:
        break;
    }
    hid_send_feature_report(dev, buf, sizeof(buf));

    memcpy(buf, four, sizeof(buf));
    if (send_color) {
        buf[4] = red;
        buf[5] = grn;
        buf[6] = blu;
        buf[8] = 0xeb - (buf[4]+buf[5]+buf[6]);
    }
    hid_send_feature_report(dev, buf, sizeof(buf));
    
    std::this_thread::sleep_for(SUNREX_KEYBOARD_DELAY);
}

